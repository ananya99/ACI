# @package _global_

defaults:
  # Use one maze for the time being
  - /env/mazes/SQUARE_OPEN@env.mazes.SQUARE

  # Adds two objects to the environment: a goal and an adversarial object
  - /env/objects@env.objects.goal: goal
  - /env/objects@env.objects.adversary: adversary

  # Use the maze_exp config as the base
  - /exp/maze_exp

  # Define one animal
  - /env/animals@env.animals.animal_0: ${env/animals}
  - /env/animals/eyes@env.animals.animal_0.eyes.eye: ${env/animals/eyes}
  - override /env/animals: point

  - override /trainer/model/policy_kwargs: cnn

trainer:
  # decrease the number of timesteps to speed up the sweep
  total_timesteps: 750_000

env:
  reward_fn:
    goal_in_view:
      _target_: cambrian.envs.reward_fns.reward_if_objects_in_view
      _partial_: true
      reward_in_view: 0.5
      reward_not_in_view: -0.1
      from_animals: [animal_0]
      to_objects: [goal]
      scale_by_distance: true
    adversary_not_in_view:
      _target_: cambrian.envs.reward_fns.reward_if_objects_in_view
      _partial_: true
      reward_in_view: -0.4
      from_animals: [animal_0]
      to_objects: [adversary]

  objects:
    goal:
      xml:
        overrides:
          - mujoco:
              - worldbody:
                  - body:
                      - name: ${parent:xml}_body
                      - childclass: object
                      - site:
                          - name: ${parent:xml}_geom
                          - euler: "0 90 0"
              - asset:
                  - texture:
                      - name: "${parent:xml}_tex"
                      - builtin: "checker"
                      - rgb1: "0.8 0.2 0.2"
                      - rgb2: "0.2 0.2 0.8"
                      - height: "10"
                      - width: "10"
                      - type: "2d"
                  - material:
                      - name: ${parent:xml}_mat
                      - texture: "${parent:xml}_tex"
                      - texrepeat: "5 5"
                      - emission: 1
                  - material:
                      - name: ${parent:xml}_top_mat
                      - rgba: 0.2 0.8 0.2 1.0
                      - emission: 2

    adversary:
      xml:
        overrides:
          - mujoco:
              - worldbody:
                  - body:
                      - name: ${parent:xml}_body
                      - childclass: object
                      - site:
                          - name: ${parent:xml}_geom
                          - euler: "0 90 0"
              - asset:
                  - texture:
                      - name: "${parent:xml}_tex"
                      - builtin: "checker"
                      - rgb1: "0.8 0.2 0.2"
                      - rgb2: "0.2 0.2 0.8"
                      - height: "10"
                      - width: "10"
                      - type: "2d"
                  - material:
                      - name: ${parent:xml}_mat
                      - texture: "${parent:xml}_tex"
                      - texrepeat: "2 2"
                      - emission: 1
                  - material:
                      - name: ${parent:xml}_top_mat
                      - rgba: 0.8 0.2 0.2 1.0
                      - emission: 2

  animals:
    animal_0:
      # Up the ctrl range to make the environment more difficult
      xml:
        overrides:
          - mujoco:
              - actuator:
                  - velocity:
                      - name: "act_x_${parent:xml}"
                      - ctrlrange: "-100.0 100.0"
                  - velocity:
                      - name: "act_y_${parent:xml}"
                      - ctrlrange: "-100.0 100.0"

      num_eyes_to_generate: [1, 1]

      # The eyes can be placed anywhere on the longitudinal axis
      eyes_lon_range: [-90, 90]

      eyes:
        # Each eye while will have a resolution of 1x1 and a field of view of 10x10
        eye:
          resolution: [1, 1]
          fov: [45, 45]

hydra:
  sweeper:
    parametrization:
      # Just evolve the longitudinal number of eyes for now, i.e. flatland
      env.animals.animal_0.num_eyes_to_generate.1:
        init: 1
        lower: 1
        upper: 100
        step: 5
        integer: true

    # Add a cheap constraint to restrict the number of eyes generated to be
    # "anatomically feasible"
    cheap_constraints:
      - _target_: cambrian.ml.constraint_fns.nevergrad_constraint_fn
        _partial_: true
        fn: cambrian.ml.constraint_fns.constrain_anatomically_feasible_eyes
        num_lon_eyes_to_generate: env.animals.animal_0.num_eyes_to_generate.1
        width: env.animals.animal_0.eyes.eye.resolution.0
        lon_range: ${env.animals.animal_0.eyes_lon_range}
